---
- name: Install Git server
  hosts: repository
  vars_prompt:
    - name: "publicKeyLocation"
      prompt: "Enter the location of the public ssh key you want to use for connecting to the Git server"
      private: no
  tasks:
    - name: Create necessary folders for Git server
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0775
      loop:
        - "{{ git_server_folder }}"
        - "{{ git_keys_folder }}"
        - "{{ git_repos_folder }}"
    - name: Set up public key
      copy:
        src: "{{ publicKeyLocation }}"
        dest: "{{ git_keys_folder }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0644
    - name: Run Git server in a Docker container
      docker_container:
        name: git-server
        image: jkarlos/git-server-docker
        state: started
        volumes:
        - "{{ git_keys_folder }}"
        - "{{ git_repos_folder }}"
        ports:
          - "2222:22"
      vars:
        ansible_python_interpreter: /bin/python3

- name: Install Docker registry
  hosts: repository
  tasks:
    - name: Create necessary folder for Docker registry
      file:
        path: "/home/{{ ansible_user }}/docker-registry"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: 0775
    - name: Run Docker registry in a container
      become: yes
      docker_container:
        name: docker-registry
        image: registry:2
        state: started
        volumes:
          - "/home/{{ ansible_user }}/docker-registry:/var/lib/registry"
        ports:
          - "5000:5000"
      vars:
        ansible_python_interpreter: /bin/python3
